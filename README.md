This is a script that extends shadow experiments generated by [tornettools](https://github.com/shadow/tornettools) for experimenting on pluggable transports.

### How to use

The ptnettools.py script is meant to be run on the shadow.config.yaml files generated by tornettools. Follow the steps for setting up an experiment with tornettools up to and including the [`tornettools generate`](https://github.com/shadow/tornettools/tree/main#now-we-can-used-the-staged-files-to-generate-many-times).

At the moment, this script supports the following transports: obfs4

1. Build the PT binary and note the path

2. Modify the generated experiment directory by running
```
./ptnettools.py --path [experiment directory --transport obfs4 --transport-bin-path [path to pt binary]
```

Then, continue with the remaining steps of running and visualizing tornettools.

### Updating the network model

### Shadow notes

We want at least 10 runs of 10% network. We can just call generate 10 times and then reuse those 10 samples for each of the cases being compared.

for i in `seq 0 9`; do
  tornettools generate \
        relayinfo_staging_2023-04-01--2023-04-30.json \
        userinfo_staging_2023-04-01--2023-04-30.json \
        networkinfo_staging.gml \
        tmodel-ccs2018.github.io \
        --network_scale 0.01 \
        --prefix tornet-0.01-$i
done
mkdir case1
for i in `seq 0 9`; do
  cp -r tornet-0.01-$i case1/
done

for i in `seq 0 4`; do
  numactl --cpunodebind=0 --membind=0 tornettools simulate -a '--parallelism=8 --seed=666 --template-directory=shadow.data.template' case1/tornet-0.01-$i
done &
for i in `seq 5 9`; do
  numactl --cpunodebind=1 --membind=1 tornettools simulate -a '--parallelism=8 --seed=666 --template-directory=shadow.data.template' case1/tornet-0.01-$i
done &

End directory structure will be like:

experiments/
|__ case1/
    |__ tornet-0.1-0/
    |__ tornet-0.1-2/
    |__ tornet-0.1-9/
|__ case2/
    |__ tornet-0.1-0/
    |__ tornet-0.1-2/
    |__ tornet-0.1-9/


- pin to the a-sides (shadow does this by default)
- numactl to pin each exp to one numa node and to a-sides
  numactl --cpunodebind=0 --membind=0 or numactl --cpunodebind=1 --membind=1

- one screen session per numanode with env variable for NUMA node
- run half on each about
- run one experiment at a time on each node


- right now we're pointing all perf clients through the bridge, but maybe we don't want that kind of bottleneck??

- note: pass in shadow args necessary for the Go PT experiments
e.g.,
  numactl --cpunodebind=1 --membind=1 tornettools simulate -a '--parallelism=8 --seed=666 --template-directory=shadow.data.template --model-unblocked-syscall-latency=true' tornet-0.01

- be aware of this: https://shadow.github.io/docs/guide/system_configuration.html

### Snowflake experiments

- need the server patch
